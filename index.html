<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Hệ thống giám sát IoT cho smart home - Quản lý nhiệt độ, độ ẩm, ánh sáng">
    <meta name="author" content="Lê Quang Minh Nhật, Thái Hữu Lợi, Trần Hữu Đạo">
    <meta name="theme-color" content="#2563eb">
    <title>Hệ Thống Giám Sát IoT</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>

<body>
    <noscript>
        <div style="padding: 20px; background: #fee2e2; color: #991b1b; text-align: center; font-weight: 600;">
            ⚠️ Ứng dụng này yêu cầu JavaScript. Vui lòng bật JavaScript trong trình duyệt của bạn.
        </div>
    </noscript>
    <nav class="sidebar" id="sidebar">
        <div class="logo">
            <div class="logo-content">
                <i class="fa-solid fa-server"></i>
                <span class="logo-text">IoT Manager</span>
            </div>
            <button type="button" id="sidebar-toggle" class="btn-toggle" aria-label="Toggle sidebar">
                <i class="fa-solid fa-bars" aria-hidden="true"></i>
            </button>
        </div>

        <div class="menu">
            <a href="#" class="active" onclick="switchTab('dashboard')" aria-label="Quản lý">
                <i class="fa-solid fa-house" aria-hidden="true"></i>
                <span class="menu-text">Quản lý</span>
            </a>
            <a href="#" onclick="switchTab('report')" aria-label="Dashboard">
                <i class="fa-solid fa-chart-line" aria-hidden="true"></i>
                <span class="menu-text">Dashboard</span>
            </a>
            <a href="#" onclick="switchTab('export')" aria-label="Dữ liệu">
                <i class="fa-solid fa-table-list" aria-hidden="true"></i>
                <span class="menu-text">Dữ liệu</span>
            </a>
            <a href="#" onclick="switchTab('setting')" aria-label="Cấu hình">
                <i class="fa-solid fa-gear" aria-hidden="true"></i>
                <span class="menu-text">Cấu hình</span>
            </a>
        </div>
    </nav>

    <main class="main-content">
        <header>
            <h1>Quản lý các phòng</h1>
            <div class="badges">
                <span id="mqtt-status" class="badge error">MQTT: Disconnected</span>
                <span id="db-status" class="badge warning">Firebase: Connecting...</span>
            </div>
            <div class="header-right">
                <div class="user-info-box">
                    <i class="fa-regular fa-user"></i>
                    <span id="user-email-display">Loading...</span>
                </div>
                <button type="button" id="logout-btn" class="btn-logout" title="Đăng xuất" aria-label="Đăng xuất">
                    <i class="fa-solid fa-right-from-bracket" aria-hidden="true"></i>
                </button>
            </div>
        </header>

        <div class="grid-container" id="device-grid">
            <div class="card add-card" id="btn-open-modal" role="button" tabindex="0" aria-label="Thêm thiết bị mới">
                <div class="dashed-border">
                    <i class="fa-solid fa-plus" aria-hidden="true"></i>
                    <span>Thêm Thiết Bị</span>
                </div>
            </div>
        </div>

        <div id="report-view" style="display: none;">
            <h2>Phòng</h2>
        </div>

        <div id="report-list" class="report-grid">
        </div>

        <div class="master-control-area">
            <button type="button" id="master-switch" class="master-btn is-on" aria-label="Tắt toàn bộ hệ thống">
                <i class="fa-solid fa-power-off" aria-hidden="true"></i> <span>TẮT TOÀN BỘ HỆ THỐNG</span>
            </button>
        </div>

        <div id="report-detail" class="modal" style="display: none;">

            <div class="modal-content"
                style="margin-top: 50px; width: 95%; max-width: 1000px; height: 85vh; display: flex; flex-direction: column; padding: 20px;">
                <span class="close-button" onclick="closeReportDetail()"
                    style="align-self: flex-end; font-size: 30px; cursor: pointer;">&times;</span>

                <div class="detail-header-simple">
                    <h3 id="report-title" style="margin: 0; color: #2563eb;">Chi Tiết Phòng</h3>

                </div>

                <div class="stats-row">
                    <div class="stat-box main-power" id="stat-power-box">
                        <div class="stat-icon"><i class="fa-solid fa-power-off"></i></div>
                        <div class="stat-info">
                            <span>Nguồn Phòng</span>
                            <h4 id="detail-power-status">---</h4>
                        </div>
                    </div>
                    <div class="stat-box temp" id="btn-chart-temp" onclick="selectChartType('temp')">
                        <div class="stat-icon"><i class="fa-solid fa-temperature-half"></i></div>
                        <div class="stat-info">
                            <span>Nhiệt Độ</span>
                            <h4 id="detail-temp">-- °C</h4>
                        </div>
                    </div>
                    <div class="stat-box humid" id="btn-chart-humid" onclick="selectChartType('humid')">
                        <div class="stat-icon"><i class="fa-solid fa-droplet"></i></div>
                        <div class="stat-info">
                            <span>Độ Ẩm</span>
                            <h4 id="detail-humid">-- %</h4>
                        </div>
                    </div>
                    <div class="stat-box light" id="btn-chart-light" onclick="selectChartType('light')">
                        <div class="stat-icon"><i class="fa-solid fa-sun"></i></div>
                        <div class="stat-info">
                            <span>Ánh Sáng</span>
                            <h4 id="detail-light">-- Lux</h4>
                        </div>
                    </div>
                </div>

                <div class="chart-control-wrapper">

                    <div class="chart-section">
                        <canvas id="myChart"></canvas>
                    </div>

                    <div class="control-section">
                        <h4>Quick Control</h4>
                        <div class="control-item">
                            <div class="control-label">
                                <i class="fa-solid fa-fan"></i> Quạt Gió
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="toggle-fan" onchange="toggleFeature('fan')">
                                <span class="slider round"></span>
                            </label>
                        </div>

                        <div class="control-item">
                            <div class="control-label">
                                <i class="fa-solid fa-lightbulb"></i> Đèn Phòng
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="toggle-lamp" onchange="toggleFeature('lamp')">
                                <span class="slider round"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="setting-view" style="display: none; max-width: 800px; margin: 0 auto;">
            <div class="card"
                style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
                <h2 style="margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                    <i class="fa-solid fa-fire"></i> Cấu hình Firebase
                </h2>

                <p style="color: #666; font-size: 0.9rem; margin-bottom: 20px;">
                    Nhập thông tin từ Project Settings trong Firebase Console. Sau khi lưu, trang web sẽ tải lại để áp
                    dụng.
                </p>

                <form id="firebase-setup-form" onsubmit="saveFirebaseSettings(event)">
                    <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <div class="form-group">
                                <label>API Key:</label>
                                <input type="text" id="cfg-apiKey" required placeholder="AIzaSy..."
                                    style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                            </div>
                            <div class="form-group">
                                <label>Auth Domain:</label>
                                <input type="text" id="cfg-authDomain" required placeholder="project.firebaseapp.com"
                                    style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-top: 10px;">
                            </div>
                            <div class="form-group">
                                <label>Database URL:</label>
                                <input type="text" id="cfg-databaseURL" required
                                    placeholder="https://...firebasedatabase.app"
                                    style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-top: 10px;">
                            </div>
                            <div class="form-group">
                                <label>Project ID:</label>
                                <input type="text" id="cfg-projectId" required
                                    style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-top: 10px;">
                            </div>
                        </div>

                        <div>
                            <div class="form-group">
                                <label>Storage Bucket:</label>
                                <input type="text" id="cfg-storageBucket"
                                    style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                            </div>
                            <div class="form-group">
                                <label>Messaging Sender ID:</label>
                                <input type="text" id="cfg-messagingSenderId"
                                    style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-top: 10px;">
                            </div>
                            <div class="form-group">
                                <label>App ID:</label>
                                <input type="text" id="cfg-appId" required
                                    style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-top: 10px;">
                            </div>
                            <div class="form-group">
                                <label>Measurement ID:</label>
                                <input type="text" id="cfg-measurementId"
                                    style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-top: 10px;">
                            </div>
                        </div>
                    </div>

                    <div class="actions" style="margin-top: 30px; display: flex; gap: 15px;">
                        <button type="submit" class="btn-primary"
                            style="padding: 12px 25px; cursor: pointer; background: var(--primary-color); color: white; border: none; border-radius: 6px;">
                            <i class="fa-solid fa-save"></i> Lưu Cấu Hình & Khởi Động Lại
                        </button>
                        <button type="button" onclick="clearFirebaseSettings()"
                            style="padding: 12px 25px; cursor: pointer; background: #ef4444; color: white; border: none; border-radius: 6px;">
                            <i class="fa-solid fa-trash"></i> Xóa & Dùng Mặc Định
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div id="export-view" style="display: none;">
            <div class="card" style="background: white; padding: 20px; border-radius: 10px;">
                <h2 style="margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                    Lịch sử dữ liệu
                </h2>

                <div style="margin: 20px 0; display: flex; gap: 10px;">
                    <button type="button" onclick="fetchAllHistoryData()" class="btn-primary"
                        style="padding: 10px 20px;">
                        <i class="fa-solid fa-cloud-arrow-down"></i> Tải Dữ Liệu Từ Firebase
                    </button>
                    <button type="button" onclick="exportTableToExcel()" class="btn-primary"
                        style="background: #10b981;">
                        <i class="fa-solid fa-file-excel"></i> Xuất Excel (Option)
                    </button>
                </div>

                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;">STT</th>
                                <th>Phòng (Room)</th>
                                <th>Thời Gian (Date & Time)</th>
                                <th>Nhiệt độ (°C)</th>
                                <th>Độ ẩm (%)</th>
                                <th>Ánh sáng (Lux)</th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                            <tr>
                                <td colspan="6" style="text-align: center; color: #666;">Chưa có dữ liệu. Hãy nhấn nút
                                    "Tải Dữ Liệu".</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="footer">
            <footer class="main-footer">
                <div class="footer-content">
                    <div class="footer-section">
                        <h4>Tên</h4>
                        <p>Lê Quang Minh Nhật</p>
                        <p>Thái Hữu Lợi</p>
                        <p>Trần Hữu Đạo</p>
                    </div>
                    <div class="footer-section">
                        <h4>MSSV</h4>
                        <p>23139026</p>
                        <p>23139027</p>
                        <p>23139028</p>
                    </div>
                    <div class="footer-section">
                        <h4>email</h4>
                        <p>lequangminhnhat@example.com</p>
                        <p>thaihuuloi@example.com</p>
                        <p>tranhuudao@example.com</p>
                    </div>
                </div>
                <div class="footer-bottom">
                    &copy; 2025 Smart Home IoT Project. All rights reserved.
                </div>
            </footer>
        </div>

    </main>
    <!-- thêm thiết bị mới -->
    <div id="add-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3>Thêm Thiết Bị Mới</h3>
            <form id="add-form">
                <div class="form-group">
                    <label>Tên Phòng / Vị Trí</label>
                    <input type="text" id="dev-name" placeholder="Vd: Phòng Khách" required>
                </div>
                <div class="form-group">
                    <label>Mã Chip (ESP32 ID)</label>
                    <input type="text" id="dev-id" placeholder="Vd: esp32_01" required>
                    <small>Phải trùng với mã nạp trong code ESP32</small>
                </div>
                <div class="form-group">
                    <label>Chu kỳ đo (Giây)</label>
                    <input type="number" id="dev-interval" value="30" min="5">
                </div>
                <button type="submit" class="btn-primary" style="width:100%">Lưu Thiết Bị</button>
            </form>
        </div>
    </div>
    <!-- Sửa thiết bị -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3>Cập Nhật Thiết Bị</h3>
            <form id="edit-form">
                <div class="form-group">
                    <label>Mã Chip (ID):</label>
                    <input type="text" id="edit-dev-id" disabled style="background: #f0f0f0; color: #666;">
                </div>

                <div class="form-group">
                    <label>Tên hiển thị mới:</label>
                    <input type="text" id="edit-dev-name" required>
                </div>

                <div class="form-group">
                    <label>Chu kỳ đo (Giây):</label>
                    <input type="number" id="edit-dev-interval" min="5" required>
                </div>

                <div class="modal-actions" style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn-primary" style="flex: 1;">Lưu Thay Đổi</button>
                    <button type="button" id="btn-delete-device" class="btn-danger" style="flex: 1;">
                        <i class="fa-solid fa-trash"></i> Xóa Thiết Bị
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script type="module" src="script.js"></script>
</body>

</html>