Báo cáo lỗi — Kiểm tra tệp nguồn (100% tĩnh)
Ngày tạo: 2025-12-15 (cập nhật mới nhất: 2025-12-15 17:50)
Nhánh hiện tại: test

Tóm tắt:
- Tổng số tệp kiểm tra: 7 (tệp chính trong thư mục gốc)
- Vấn đề nghiêm trọng còn tồn: 1 (thẻ `</form>` thừa trong `login.html` — chưa sửa theo yêu cầu)
- Vấn đề trung bình/nhỏ (nên sửa): 6
- Gợi ý bảo mật & cải thiện: nhiều mục (xem chi tiết từng file)

Tệp đã kiểm tra: `index.html`, `login.html`, `auth.js`, `firebase-config.js`, `login-login.js`, `script.js`, `style.css`.

Chi tiết theo tệp (tiếng Việt):

1) `login.html`
- Lỗi nghiêm trọng — Thẻ `</form>` thừa
  - Mô tả: Có một thẻ đóng `</form>` thừa sau `.auth-container` trước `#config-modal`. Thẻ này làm vỡ cấu trúc DOM, khiến một số `getElementById` trả về `null` và gây lỗi khi script sử dụng các phần tử đó.
  - Hành động sửa: Xóa thẻ `</form>` thừa (chỉ giữ một thẻ đóng `</form>` tương ứng với `<form id="auth-form">`).

- Cải tiến — Dùng `window.addEventListener` thay vì gán `window.onclick`
  - Mô tả: Gán trực tiếp `window.onclick = ...` sẽ ghi đè handler khác. Nên dùng `window.addEventListener('click', handler)` để tránh xung đột.

2) `login-login.js`
- Lỗi logic — `switch` có `case` trùng lặp
  - Mô tả: Trong `showError` có hai `case 'auth/user-not-found'`. Xoá case trùng hoặc sửa case đúng.

- Cải tiến — Kiểm tra tồn tại DOM trước khi đăng ký sự kiện
  - Mô tả: Dùng `if (form) { ... }` để tránh lỗi khi phần tử không tồn tại do HTML bị sai.

3) `firebase-config.js` (ĐÃ SỬA)
- Vấn đề vận hành — Khởi tạo Firebase khi config rỗng (đã xử lý)
  - Mô tả trước đây: `initializeApp(finalConfig)` được gọi dù config rỗng, có thể gây lỗi.
  - Thay đổi: Đã thêm kiểm tra `finalConfig.apiKey` và bao bởi `try/catch`. Nếu không thấy `apiKey`, Firebase sẽ không được khởi tạo và một cảnh báo sẽ được log vào console. Nếu lỗi xảy ra trong quá trình khởi tạo, lỗi được bắt và log.
  - Lợi ích: Tránh ném lỗi không rõ khi trang tải mà chưa có cấu hình; cho phép UI hiển thị hướng dẫn để người dùng cấu hình.

4) `auth.js`
- Thông tin — Import từ local + CDN
  - Mô tả: Pattern này hợp lệ nhưng phụ thuộc CDN. Không bắt buộc phải thay đổi, nhưng cân nhắc đồng bộ import nếu muốn.

5) `script.js` (ĐÃ SỬA)
- Lỗi nghiêm trọng — Tạo `innerHTML` chứa `onclick` với dữ liệu không escape (đã sửa)
  - Mô tả trước đây: `renderGrid` chèn `device.name`, `deviceId` vào `innerHTML` và vào thuộc tính `onclick`. Nếu các chuỗi chứa dấu nháy hoặc ký tự đặc biệt, HTML/JS bị vỡ hoặc có thể gây XSS.
  - Thay đổi: Đã refactor `renderGrid` để tạo DOM bằng `document.createElement`, chèn `textContent` cho chuỗi do user/device cung cấp, và dùng `addEventListener` để gắn sự kiện `click` cho các nút (không dùng `onclick` inline). Biểu mẫu hiển thị và các nút (Sửa, Bật/Tắt) vẫn hoạt động như trước nhưng an toàn hơn với chuỗi chứa dấu nháy hoặc ký tự đặc biệt.
  - Lợi ích: Loại bỏ rủi ro gây vỡ HTML do chuỗi chưa escape và giảm nguy cơ XSS.

- Cải tiến — Kiểm tra tồn tại phương thức trạng thái MQTT (đã sửa)
  - Mô tả trước đây: `sendCommand` gọi `mqttClient.isConnected()` trực tiếp.
  - Thay đổi: Kiểm tra tồn tại `mqttClient` và kiểm tra an toàn nếu `isConnected` là hàm hoặc thuộc tính; nếu không có cờ kết nối, kiểm tra `mqttClient.connected`. Nếu không kết nối, thông báo cho người dùng.

- Cải tiến — Thay `window.onclick` bằng `window.addEventListener` (đã sửa trong `script.js`)
  - Mô tả: Các chỗ trong `script.js` trước đây dùng `window.onclick = ...` đã được chuyển sang `window.addEventListener('click', ...)` để tránh ghi đè handler toàn cục.

6) `style.css` (ĐÃ SỬA - CẬP NHẬT MỚI NHẤT)
- Thông tin / gợi ý
  - Mô tả: Không tìm thấy lỗi cú pháp rõ rệt. Một số khai báo CSS bị lặp (ví dụ `.master-control-area` khai báo 2 lần; `.btn-primary` xuất hiện nhiều nơi). Điều này không gây lỗi nhưng làm khó bảo trì và có thể gây nhầm khi chỉnh style.
  - Hành động sửa: Dọn dẹp khai báo trùng lặp, gom các biến CSS vào `:root` nếu cần.

- CẬP NHẬT 2025-12-15: Sửa CSS cho card trong Dashboard (Report)
  - Mô tả: Đã cập nhật CSS cho `.report-card` và `.report-grid` để đồng nhất với thiết kế card trong phần Quản lý
  - Thay đổi chi tiết:
    + `.report-grid`: Thay đổi grid-template-columns từ `minmax(250px, 1fr)` sang `minmax(300px, 1fr)` để card rộng hơn và đồng nhất với `.grid-container`
    + `.report-grid`: Thêm `flex: 1` để layout responsive tốt hơn
    + `.report-card`: Thêm `cursor: pointer` để hiển thị con trỏ khi hover
    + Loại bỏ các style riêng lẻ cho `.report-card h3` và `.report-card p` vì đã dùng chung cấu trúc DOM với `.card`
  - Lợi ích: Card trong Dashboard (Report) giờ có giao diện giống hệt card trong Quản lý, bao gồm: header, device-id, status dot, 3 metrics trong grid, và 2 buttons (Sửa, Tắt/Bật)

7) `script.js` - renderReportList() (ĐÃ SỬA - CẬP NHẬT MỚI NHẤT 17:50)
- CẬP NHẬT 2025-12-15: Refactor hàm renderReportList() để đồng nhất với renderGrid()
  - Mô tả trước đây: Hàm `renderReportList()` tạo card đơn giản bằng `innerHTML` với chỉ có tên, ID và 1 button "Xem Chi Tiết"
  - Thay đổi chi tiết:
    + Thay thế hoàn toàn logic render bằng cách tạo DOM elements giống hệt hàm `renderGrid()`
    + Card giờ có đầy đủ: Header (title + device ID + chip icon), Status row (status dot + text), Metrics grid (3 cột: nhiệt độ, độ ẩm, ánh sáng), Actions (2 buttons: Sửa và Tắt/Bật)
    + Sử dụng `addEventListener` thay vì `onclick` inline cho tất cả sự kiện
    + Thêm xử lý lỗi với thông báo màu đỏ khi có exception
  - Lợi ích: 
    + Giao diện thống nhất giữa phần Quản lý và Dashboard (Report)
    + An toàn hơn (không dùng innerHTML với dữ liệu động)
    + UX tốt hơn với các button Sửa và Tắt/Bật ngay trên card
    + Code dễ bảo trì hơn vì sử dụng cùng pattern với renderGrid()

- CẬP NHẬT 2025-12-15 17:50 (NHÁNH TEST): Sửa lỗi event bubbling trong Dashboard (Report)
  - Vấn đề: Khi nhấn nút "Sửa" trong Dashboard (Report), card vẫn mở chart thay vì mở modal sửa
  - Nguyên nhân: Event listener của card được gắn trước khi append các phần tử con, và `stopPropagation()` không hoạt động đúng thứ tự
  - Thay đổi chi tiết:
    + Di chuyển event listener của card xuống CUỐI, sau khi đã append tất cả các phần tử con
    + Thay đổi logic xử lý click: Thay vì dùng `stopPropagation()` ở button, giờ kiểm tra target của event ở cấp card
    + Sử dụng `e.target.tagName === 'BUTTON'` và `e.target.closest('button')` để phát hiện click vào button hoặc phần tử con của button (như icon)
    + Loại bỏ `e.stopPropagation()` khỏi các button event handler vì không còn cần thiết
  - Code mới:
    ```javascript
    // Add click listener to card AFTER all elements are appended
    card.addEventListener('click', (e) => {
        // If clicked element or its parent is a button, don't open chart
        if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
            return;
        }
        showChart(deviceId, device.name);
    });
    ```
  - Lợi ích:
    + Nút "Tắt/Bật" thay đổi trạng thái thiết bị mà không mở chart
    + Click vào bất kỳ vùng nào khác của card sẽ mở chart
    + Logic rõ ràng và dễ debug hơn (kiểm tra target thay vì dựa vào event bubbling)

- CẬP NHẬT 2025-12-15 17:58 (NHÁNH TEST): Thay đổi hành vi nút "Sửa" trong Dashboard (Report)
  - Yêu cầu: Nút "Sửa" trong Dashboard (Report) cũng mở chart thay vì mở modal sửa
  - Thay đổi: Thay đổi event handler của nút "Sửa" từ `window.triggerEdit(...)` sang `showChart(...)`
  - Lý do: Trong Dashboard (Report), người dùng muốn xem chi tiết chart khi nhấn vào nút "Sửa", khác với phần Quản lý (nơi nút "Sửa" vẫn mở modal sửa)
  - Code:
    ```javascript
    btnEdit.addEventListener('click', () => {
        showChart(deviceId, device.name);
    });
    ```
  - Lợi ích:
    + Cả nút "Sửa" và click vào card đều mở chart
    + Chỉ có nút "Tắt/Bật" thay đổi trạng thái thiết bị
    + UX phù hợp với mục đích xem báo cáo/dashboard

- CẬP NHẬT 2025-12-15 18:04 (NHÁNH TEST): Thay thế 2 nút bằng 1 nút "Xem Chi Tiết" trong Dashboard (Report)
  - Yêu cầu: Thay thế 2 nút "Sửa" và "Bật/Tắt" bằng 1 nút duy nhất "Xem Chi Tiết" màu xanh dương
  - Thay đổi chi tiết:
    + Xóa 2 buttons: `btnEdit` (nút Sửa) và `btnPower` (nút Bật/Tắt)
    + Tạo 1 button mới: `btnDetail` với text "Xem Chi Tiết"
    + Button có class `btn-sm btn-primary` (màu xanh dương)
    + Button chiếm toàn bộ chiều rộng của card-actions (`width: 100%`)
    + Thêm icon chart: `<i class="fa-solid fa-chart-line"></i>`
    + Event handler: gọi `showChart(deviceId, device.name)`
  - Code:
    ```javascript
    const btnDetail = document.createElement('button');
    btnDetail.className = 'btn-sm btn-primary';
    btnDetail.style.width = '100%';
    btnDetail.innerHTML = '<i class="fa-solid fa-chart-line"></i> Xem Chi Tiết';
    btnDetail.addEventListener('click', () => {
        showChart(deviceId, device.name);
    });
    actions.appendChild(btnDetail);
    ```
  - Lợi ích:
    + Giao diện đơn giản hơn, chỉ 1 button thay vì 2
    + Mục đích rõ ràng: Dashboard là để xem báo cáo, không phải quản lý
    + Button màu xanh dương nổi bật, dễ nhận biết
    + Chiếm toàn bộ chiều rộng nên dễ click hơn
    + Icon chart giúp người dùng hiểu ngay mục đích của button

- CẬP NHẬT 2025-12-15 18:08 (NHÁNH TEST): Sửa lỗi biểu đồ cập nhật khi toggle switches
  - Vấn đề: Mỗi khi nhấn nút "Nguồn Phòng", gạt công tắc "Quạt Gió" hoặc "Đèn Phòng", biểu đồ bị cập nhật và thêm dữ liệu mới, làm chart kéo dài không đúng
  - Nguyên nhân: Hàm `showChart()` có listener `onValue` lắng nghe TẤT CẢ thay đổi trên `devices/${deviceId}`, bao gồm cả thay đổi trạng thái (`active`, `fan_active`, `lamp_active`). Mỗi khi có bất kỳ thay đổi nào, code đều đẩy dữ liệu vào `cachedHistoryData` và update chart, dù dữ liệu sensor (temp, humid, light) không thay đổi
  - Thay đổi chi tiết:
    + Thêm biến `lastSensorData` để theo dõi giá trị sensor trước đó: `{ temp: null, humid: null, light: null }`
    + Thêm logic kiểm tra xem dữ liệu sensor có thực sự thay đổi không:
      ```javascript
      const sensorChanged = 
          lastSensorData.temp !== data.temp ||
          lastSensorData.humid !== data.humid ||
          lastSensorData.light !== data.light;
      ```
    + CHỈ cập nhật chart khi `sensorChanged === true` VÀ dữ liệu sensor hợp lệ (không undefined)
    + Cập nhật `lastSensorData` sau mỗi lần push dữ liệu vào chart
  - Code:
    ```javascript
    let lastSensorData = { temp: null, humid: null, light: null };
    
    onValue(ref(db, `devices/${deviceId}`), (snapshot) => {
        const data = snapshot.val();
        // ... update UI elements ...
        
        // CHỈ update chart khi sensor data thay đổi
        const sensorChanged = 
            lastSensorData.temp !== data.temp ||
            lastSensorData.humid !== data.humid ||
            lastSensorData.light !== data.light;

        if (sensorChanged && data.temp !== undefined && data.humid !== undefined && data.light !== undefined) {
            lastSensorData = { temp: data.temp, humid: data.humid, light: data.light };
            // ... push to cachedHistoryData and update chart ...
        }
    });
    ```
  - Lợi ích:
    + Chart chỉ cập nhật khi có dữ liệu sensor mới thực sự (temp, humid, light thay đổi)
    + Nhấn nút Nguồn Phòng, Quạt Gió, Đèn Phòng KHÔNG làm chart update
    + Biểu đồ không bị kéo dài không cần thiết
    + Performance tốt hơn vì không render chart mỗi lần toggle
    + Dữ liệu chart chính xác hơn, chỉ phản ánh thay đổi sensor

- CẬP NHẬT 2025-12-15 18:43-18:46 (NHÁNH TEST): Sửa lỗi dữ liệu Lux/Light không hiển thị  
  - Vấn đề: Web không lấy được dữ liệu lux/light từ Firebase, hiển thị "-- Lux" thay vì giá trị thực
  - Phương án debug: Thêm console.log để kiểm tra cấu trúc dữ liệu Firebase
  - Kết quả debug: User xác nhận Firebase sử dụng field name `lux` chứ không phải `light`
    ```
    Firebase structure:
    {
      temp: 31,
      humid: 58,
      lux: 1578  ← Đúng field name
    }
    ```
  - Nguyên nhân: Code đang đọc `data.light` và `device.light` nhưng Firebase lưu là `data.lux` và `device.lux`
  - Thay đổi chi tiết: Thay TẤT CẢ 12 chỗ sử dụng `.light` thành `.lux`:
    1. `renderGrid()`: `device.light` → `device.lux` (dòng 203)
    2. `renderReportList()`: `device.light` → `device.lux` (dòng 593)
    3. `showChart()` - history loading: `val.light` → `val.lux` (dòng 686)
    4. `showChart()` - realtime update: `data.light` → `data.lux` (dòng 729)
    5. `showChart()` - sensor change check: `data.light` → `data.lux` (dòng 741)
    6. `showChart()` - validation: `data.light !== undefined` → `data.lux !== undefined` (dòng 743)
    7. `showChart()` - lastSensorData update: `light: data.light` → `light: data.lux` (dòng 745)
    8. `showChart()` - chart data push: `data.light` → `data.lux` (dòng 755)
    9. `fetchAllHistoryData()` - history reading: `light: val.light` → `light: val.lux` (dòng 944)
    10. `fetchAllHistoryData()` - table display: `row.light` → `row.lux` (dòng 972)
  - Lợi ích:
    + Dữ liệu lux/ánh sáng hiển thị đúng trên card (cả Quản lý và Dashboard)
    + Biểu đồ cập nhật đúng dữ liệu lux
    + Bảng xuất dữ liệu hiển thị đúng
    + Đồng bộ hoàn toàn với Firebase schema
  
  - Lỗi bổ sung (18:57): Bảng Dữ Liệu hiển thị "undefined Lux"
    + Nguyên nhân: Khi tạo row object dùng key `light: val.lux` nhưng hiển thị lại dùng `row.lux`
    + Sửa: Đổi `${row.lux}` thành `${row.light}` ở dòng 959 để khớp với key của object
    + Giải thích: Object row có structure `{light: val.lux}` nên phải truy cập qua `row.light` chứ không phải `row.lux`

Khuyến nghị bảo mật & tĩnh tổng quát:
- Không chèn trực tiếp dữ liệu bên ngoài vào `innerHTML`.
- Dùng `addEventListener` để đăng ký sự kiện global thay vì gán thuộc tính `window.onclick`.
- Thêm guard khi lấy phần tử DOM: `const el = document.getElementById('x'); if (el) { ... }`.
- Validate cấu hình Firebase trước khi khởi tạo.
- Kiểm tra API chính xác của thư viện MQTT (Paho) trước khi gọi các phương thức.
- Khi xử lý event bubbling, ưu tiên kiểm tra target thay vì dùng stopPropagation() để code dễ hiểu hơn.

Gợi ý hành động tiếp theo (tôi có thể làm giúp):
1) Xóa thẻ `</form>` thừa trong `login.html` (khuyến nghị: làm ngay).
2) (Đã xong) Sửa `renderGrid` trong `script.js` để tạo DOM an toàn + `addEventListener`.
3) (Đã xong) Thêm kiểm tra trước khi `initializeApp` trong `firebase-config.js`.
4) (Đã xong) Sửa `renderReportList` trong `script.js` để đồng nhất giao diện với `renderGrid`.
5) (Đã xong) Cập nhật CSS cho `.report-card` và `.report-grid` để đồng nhất với card trong Quản lý.
6) (Đã xong - NHÁNH TEST) Sửa lỗi event bubbling khi click nút "Sửa" trong Dashboard (Report).
7) Thay tất cả `window.onclick =` bằng `window.addEventListener('click', ...)` (một số đã sửa trong `script.js`, `login.html` vẫn còn `window.onclick`).

Đã áp dụng (NHÁNH TEST): sửa `firebase-config.js`, `script.js` (renderGrid, renderReportList, event handling), và `style.css` (.report-card, .report-grid) như mô tả ở trên.

--- Kết thúc báo cáo ---


test branch test
